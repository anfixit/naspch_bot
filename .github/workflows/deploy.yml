name: Deploy SpellCheck Bot

on:
  push:
    branches: [ main, master ]

env:
  PYTHON_VERSION: '3.9'

jobs:
  lint:
    name: Code Quality Checks
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install flake8 isort
    
    - name: Check imports with isort
      run: isort --check-only --profile black src/
    
    - name: Lint with flake8
      run: |
        flake8 src/ --count --select=E9,F63,F7,F82
        flake8 src/ --count --max-line-length=79

  test:
    name: Run Tests
    runs-on: ubuntu-latest
    needs: lint
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Run tests
      run: pytest tests/ -v

  deploy:
    name: Deploy to Server
    runs-on: ubuntu-latest
    needs: [lint, test]
    if: github.ref == 'refs/heads/main'
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Copy service file
      uses: appleboy/scp-action@master
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        password: ${{ secrets.SERVER_PASSWORD }}
        source: "naspch_bot.service"
        target: "/tmp/"
    
    - name: Deploy to server
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        password: ${{ secrets.SERVER_PASSWORD }}
        script: |
          set -e
          cd /opt/naspch_bot
          
          echo "ğŸ“¥ Pulling latest code..."
          git pull origin main
          
          echo "ğŸ“¦ Installing dependencies..."
          source venv/bin/activate
          pip install -q --upgrade pip
          pip install -q -r requirements.txt
          
          echo "ğŸ“ Creating directories..."
          mkdir -p logs config
          
          echo "ğŸ”‘ Creating .env file..."
          cat > .env << ENVEOF
          BOT_TOKEN=${{ secrets.BOT_TOKEN }}
          CONFIG_FILE=config/bot_config.json
          LOG_LEVEL=INFO
          GOOGLE_CREDENTIALS_PATH=${{ secrets.GOOGLE_CREDENTIALS_PATH }}
          GOOGLE_SPREADSHEET_ID=${{ secrets.GOOGLE_SPREADSHEET_ID }}
          ENVEOF
          
          echo "ğŸ“ Creating Google credentials..."
          echo '${{ secrets.GOOGLE_CREDENTIALS_JSON }}' > config/google_credentials.json
          
          echo "ğŸ”§ Setting up systemd service..."
          cp /tmp/naspch_bot.service /etc/systemd/system/
          systemctl daemon-reload
          
          echo "ğŸ›‘ Stopping old bot..."
          systemctl stop naspch_bot || true
          
          echo "ğŸš€ Starting bot service..."
          systemctl enable naspch_bot
          systemctl start naspch_bot
          
          echo "â³ Waiting for service to start..."
          sleep 3
          
          if systemctl is-active --quiet naspch_bot; then
            echo "âœ… Bot deployed successfully!"
            systemctl status naspch_bot --no-pager
          else
            echo "âŒ Bot failed to start!"
            journalctl -u naspch_bot -n 50 --no-pager
            exit 1
          fi
